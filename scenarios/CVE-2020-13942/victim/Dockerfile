FROM ubuntu:18.04

RUN groupadd --gid 5000 elastic \
&& useradd --home-dir /home/elastic --create-home --uid 5000 \
--gid 5000 --shell /bin/sh --skel /dev/null elastic

RUN apt-get update && \
    apt-get -y install openjdk-8-jdk-headless wget unzip && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* && \
    java -version

ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64

USER elastic

WORKDIR /home/elastic

RUN mkdir /home/elastic/elasticsearch
RUN wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.4.2-linux-x86_64.tar.gz
RUN tar -xf elasticsearch-7.4.2-linux-x86_64.tar.gz -C /home/elastic/elasticsearch

RUN rm /home/elastic/elasticsearch/elasticsearch-7.4.2/config/elasticsearch.yml
COPY elasticsearch.yml /home/elasticsearch/elasticsearch-7.4.2/config/

RUN wget https://archive.apache.org/dist/unomi/1.5.0/unomi-1.5.0-bin.zip
RUN unzip unomi-1.5.0-bin.zip

ENTRYPOINT ./elasticsearch/elasticsearch-7.4.2/bin/elasticsearch -d && \
    ./unomi-1.5.0/bin/start && \
    sleep 15 && \
    ./unomi-1.5.0/bin/client -p karaf unomi:start && /bin/bash